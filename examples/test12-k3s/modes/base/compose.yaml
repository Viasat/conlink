services:
  extract-utils:
    build: {context: .}
    user: ${USER_ID:-0}:${GROUP_ID:-0}
    network_mode: none
    volumes:
      - ./utils:/conlink_utils
    command: cp /utils/wait /utils/wait.sh /utils/copy /utils/copy.sh /utils/echo /conlink_utils/

  network:
    build: {context: .}
    pid: host
    network_mode: none
    #cap_add: [SYS_ADMIN, NET_ADMIN, SYS_NICE, NET_BROADCAST, IPC_LOCK]
    privileged: true
    security_opt: [ 'apparmor:unconfined' ] # needed on Ubuntu 18.04
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker:/var/lib/docker
      - ./:/test
    working_dir: /test
    command: /app/build/conlink.js --compose-file ${COMPOSE_FILE:?COMPOSE_FILE must be set}
